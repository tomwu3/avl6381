# workflow name
name: Build avl6381 Driver (Ubuntu 5.4.0-216)

# trigger the workflow manually from the GitHub UI
on:
  workflow_dispatch:

# Define a single job named 'build'
jobs:
  build:
    # use a Linux runner
    runs-on: ubuntu-latest
    
    # steps to be executed in the job
    steps:
      # step 1: check out the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # step 2: download and extract the kernel headers and build tools for Ubuntu 5.4.0-216
      - name: Download Ubuntu Kernel Headers
        run: |
          # Install necessary packages for kernel compilation
          sudo apt-get update
          sudo apt-get install -y build-essential linux-headers-5.4.0-216-generic linux-image-5.4.0-216-generic
          
          # Create a symbolic link to make the headers accessible via a simple path
          sudo ln -s /usr/src/linux-headers-5.4.0-216-generic /lib/modules/5.4.0-216-generic/build

      # step 3: compile the driver
      # The compilation steps are combined into one run block
      - name: Compile Driver for Ubuntu Kernel
        # set environment variables and run make commands
        run: |
          # Set the kernel directory to the path of the downloaded headers
          export KERNEL_DIR="/lib/modules/5.4.0-216-generic/build"
          
          # Change into the driver's source directory
          cd avl6381
          
          # Check if the kernel directory exists before compiling
          ls -l $KERNEL_DIR
          
          # Run the compilation with the specified kernel path
          make prepare
          make KERNEL_DIR=$KERNEL_DIR

      # step 4: create a directory for the compiled modules and copy the files
      - name: Stage compiled modules
        run: |
          mkdir -p build/ko_modules
          cp /home/runner/work/avl6381/avl6381/dvb-core.ko build/ko_modules/
          cp /home/runner/work/avl6831/avl6381/dvb_usb_v2.ko build/ko_modules/
          cp /home/runner/work/avl6831/avl6381/mxl603.ko build/ko_modules/
          cp /home/runner/work/avl6831/avl6381/avl6381.ko build/ko_modules/
          cp /home/runner/work/avl6831/avl6381/it930x.ko build/ko_modules/
          ls -l build/ko_modules/

      # step 5: upload the directory as a workflow artifact
      - name: Upload Driver as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: avl6381-ubuntu-5.4.0-216-modules
          path: build/ko_modules
